### Как индекс ускоряет поиск (механика)

1. **Планировщик** оценивает селективность условия (WHERE, JOIN, ORDER BY, LIMIT) по статистике ANALYZE.
2. Если по индексу ожидается мало строк/страниц — выбирается **Index Scan** или **Bitmap Index Scan**, иначе — **Seq Scan**.
3. **B-tree**: идём по корню → веткам → листьям (**O(log N)**), получаем **TID** (номер страницы/слота) и читаем нужные кортежи из heap.
4. **Index-Only Scan**: если страница heap помечена **all-visible** (Visibility Map), данные берутся **прямо из индекса**, минуя таблицу.

  
> Индекс работает, когда предикат **sargable**: без функций над колонкой или с **выражением индекса** (expression index).


### Виды индексов в PostgreSQL (и когда их брать)


#### 1) B-tree (дефолт)

- **Операторы:** =, <, >, BETWEEN, сортировка, ORDER BY ... LIMIT, префиксный LIKE 'abc%'/text_pattern_ops.
- **Где применять:** почти все кейсы: ключи, диапазоны, сортировки, JOIN по FK.
- **Особенности:** многостолбцовые индексы используют **левый префикс**: (a,b,c) обслужит запросы по a, (a,b), но не по b без a.

#### 2) Hash

- **Операторы:** только =.
- **Когда:** узкая ниша равенства; обычно **B-tree достаточно**.

#### 3) GIN (Generalized Inverted Index)

- **Для:** jsonb (@>, ?, ?&, ?|), массивов (@>), полнотекстового поиска (tsvector @@), pg_trgm (подстроки/похожесть).
- **Плюсы:** быстрый поиск по **содержимому**/элементам.
- **Минусы:** дороже по вставкам/обновлениям; требует VACUUM/maintenance.

#### 4) GiST (Generalized Search Tree)

- **Для:** диапазоны (int4range, tstzrange — &&, @>, -|-), геометрия, близость (**KNN**: ORDER BY col <-> point), pg_trgm (вариант).
- **Плюсы:** поддерживает **поиск ближайших** и “пересекается/содержит”.
- **Минусы:** настройка оператор-классов, точность зависит от данных.

#### 5) SP-GiST

- **Для:** разрежные структуры (trie, kd-tree, quad-tree), например префиксы строк, IP-сети.
- **Когда:** специфические паттерны (поиск по префиксам, разбиение пространства).

#### 6) BRIN (Block Range Index)

- **Идея:** хранит **сводки по диапазонам страниц**, а не ключи.
- **Когда:** **очень большие** таблицы и “естественный порядок” (время, автоинкремент). Пример: логи/телеметрия.
- **Плюсы:** крошечный размер, быстрый build.
- **Минусы:** грубая селективность; не для случайно перемешанных данных.

#### Ключевые модификаторы
- **UNIQUE** — гарантирует уникальность значений.
- **PARTIAL INDEX**: CREATE INDEX ... WHERE predicate — только по “горячему” подмножеству (экономит размер/вставки).
- **EXPRESSION INDEX** : CREATE INDEX ... (lower(email)) — чтобы предикаты с функцией стали индексируемыми.
- **INCLUDE** (covering): CREATE INDEX ... (a) INCLUDE (b,c) — колонки только для **чтения из индекса** (покрывающие запросы).